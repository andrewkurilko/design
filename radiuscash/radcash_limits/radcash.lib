#!/bin/bash

QUERY_TO_SQL (){
SQL=`mysql -D $DB_NAME -u $DB_USER -p$DB_PASSWORD -e "$QUERY" 2>/dev/null`
}

CUT_SQL (){
SQL=${QUERY_TO_SQL:$CUT:${#QUERY_TO_SQL}}
}

FUNC_MAX_UID (){
QUERY="SELECT MAX( uid ) FROM users"
QUERY_TO_SQL
CUT=11
CUT_SQL
MAX_UID=$SQL
}

FUNC_MAX_GID(){
QUERY="SELECT MAX( gid ) FROM packets"
QUERY_TO_SQL
CUT=11
CUT_SQL
MAX_GID=$SQL
}

UID_TO_USERS (){
FUNC_MAX_GID

for (( i=0; i <= $MAX_GID; i++ ))
then
QUERY="SELECT razresh_minus FROM packets WHERE gid=$n"
CUT=14
CUT_SQL
GID[$n]=$SQL
fi

QUERY="SELECT gid, razresh_minus FROM packets"
QUERY_TO_SQL
SQL=${SQL:18:${#SQL}}

n=0
for i in $SQL; do
ARRAY_SQL[$n]=$i
let n=n+1
done


QUERY="SELECT uid FROM users WHERE (deposit+credit)>=0 and blocked=0"
QUERY_TO_SQL
USERS=${SQL:4:${#SQL}}
}

FUNC_HOTSPOT (){
touch $HOME_DIR/mac.tmp
for i in $USERS; do
QUERY="SELECT local_mac FROM users WHERE uid=$i"
QUERY_TO_SQL
MAC=$(echo $SQL | awk '{print $2}')

if [[ $MAC != NULL && $MAC != "" ]]
then

if ! grep -q $MAC $HOME_DIR/mac.tmp
then
QUERY="SELECT gid FROM users WHERE uid=$i"
QUERY_TO_SQL
PROFILE=$(echo $SQL | awk '{print $2}')

echo "add customer=admin username=$MAC" >>$UPLOAD
echo "create-and-activate-profile profile=$PROFILE "'"'$MAC'" customer=admin' >>$UPLOAD
echo $MAC >>$HOME_DIR/mac.tmp
fi

fi

done
rm $HOME_DIR/mac.tmp
}

FUNC_PPP (){
for i in $USERS; do
QUERY="SELECT password FROM users WHERE uid=$i"
QUERY_TO_SQL
PASSWORD=$(echo $SQL | awk '{print $2}')

if [[ $PASSWORD != NULL && $PASSWORD != "" ]]
then
QUERY="SELECT user, gid, framed_ip FROM users WHERE uid=$i"
QUERY_TO_SQL
USER=$(echo $SQL | awk '{print $4}')
PROFILE=$(echo $SQL | awk '{print $5}')
IPADDR=$(echo $SQL | awk '{print $6}')

echo "add customer=admin username=$USER password=$PASSWORD ip-address=$IPADDR" >>$UPLOAD
echo "create-and-activate-profile profile=$PROFILE "'"'$USER'" customer=admin' >>$UPLOAD
fi

done
}



SSH_UPLOAD ()
{
for (( i=0;i!=$CONNECT_SUM;i++ )); do

scp -P $USERMAN_SSH_PORT $UPLOAD $USERMAN_LOGIN@$USERMAN_IP:/
STATUS=$?
if [ $STATUS -ne 0 ]; then
sleep $CONNECT_INTERVAL
else

CMD="/import file=$(basename $UPLOAD)"
for (( i=0;i!=$CONNECT_SUM;i++ )); do
ssh -p $USERMAN_SSH_PORT $USERMAN_LOGIN@$USERMAN_IP "${CMD}" > /dev/null
STATUS=$?
if [ $STATUS -ne 0 ]; then
sleep $CONNECT_INTERVAL
else
exit
fi


done
fi

done
}
